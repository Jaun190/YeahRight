<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Hashcore – Hashpower mieten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab{display:none}
    .tab.active{display:block}
    .modal{display:none}
    .modal.show{display:flex}
    .card{background:#0b0f1a;border:1px solid #1f2937;border-radius:1rem}
    .btn{padding:.7rem 1rem;border-radius:.9rem}
    .btn-primary{background:#22d3ee;color:#031b1f}
    .btn-primary:hover{background:#06b6d4}
    .btn-ghost{background:#0f172a;border:1px solid #253046;color:#e5e7eb}
    .btn-ghost:hover{background:#111827}
    .chip{display:inline-flex;align-items:center;gap:.5rem;padding:.25rem .6rem;border-radius:9999px;border:1px solid #334155;background:#0f172a;color:#a3a3a3;font-size:.75rem}
  </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="sticky top-0 z-40 bg-gray-900/80 backdrop-blur border-b border-gray-800">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-cyan-500/20 grid place-items-center">⚡</div>
        <div class="text-xl font-extrabold tracking-tight">Hash<span class="text-cyan-400">core</span></div>
        <div id="vipBadge" class="chip hidden">VIP</div>
      </div>
      <nav class="flex items-center gap-2">
        <button class="btn btn-ghost" onclick="navTo('shop')">Shop</button>
        <button class="btn btn-ghost" onclick="navTo('dashboard')">Dashboard</button>
        <button id="adminTab" class="btn btn-ghost hidden" onclick="navTo('admin')">Admin</button>
        <button id="btnConnect" class="btn btn-primary ml-2">Mit MetaMask verbinden</button>
        <button id="btnDisconnect" class="btn btn-ghost ml-2 hidden">Trennen</button>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-1 max-w-6xl mx-auto px-4 py-6 space-y-6 w-full">
    <!-- MetaMask Banner -->
    <div id="bannerNoMM" class="hidden card p-4 border-red-700 bg-red-900/30">
      <div class="font-bold text-red-300">MetaMask nicht gefunden</div>
      <p class="text-sm mt-1 text-red-100/90">Öffne diese Seite im integrierten MetaMask‑Browser oder installiere die Erweiterung/App.</p>
      <div class="mt-3 flex flex-col sm:flex-row gap-2">
        <a href="https://metamask.app.link/dapp/hashcore.website" class="btn btn-primary text-center">In MetaMask‑App öffnen</a>
        <a href="https://metamask.io/download/" target="_blank" class="btn btn-ghost text-center">MetaMask installieren</a>
      </div>
    </div>

    <div id="bannerNetwork" class="hidden card p-3 border-yellow-700 bg-yellow-900/30 text-yellow-100">
      <div class="flex items-center justify-between">
        <div>Du bist nicht auf Ethereum Mainnet.</div>
        <button class="btn btn-primary" id="btnSwitchChain">Zu Mainnet wechseln</button>
      </div>
    </div>

    <!-- Wallet Status -->
    <div class="card p-4 flex items-center gap-3">
      <div class="text-sm text-gray-400">Wallet</div>
      <div class="font-mono text-green-400" id="walletStatus">nicht verbunden</div>
      <div class="ml-auto text-xs text-gray-400" id="chainStatus"></div>
    </div>

    <!-- SHOP -->
    <section id="shop" class="tab active">
      <div class="grid md:grid-cols-3 gap-4">
        <div class="md:col-span-2 card p-5">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold text-cyan-300">Hashpower kaufen</h2>
            <div class="chip">Aktionen nur mit Wallet‑Login</div>
          </div>
          <div id="shopContent" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3 mt-3"></div>
        </div>
        <div class="card p-5">
          <h3 class="font-semibold text-cyan-300">Zahlung (MetaMask)</h3>
          <p class="text-sm text-gray-400 mt-1">Die Transaktion öffnet sich in deiner Wallet.</p>
          <div class="text-xs text-gray-400 mt-3 mb-1">Empfänger</div>
          <div id="ethTo" class="font-mono break-all text-yellow-300 text-sm"></div>
        </div>
      </div>
      <div class="text-xs text-gray-500 mt-2">Hinweis: Nach Zahlung muss das Paket durch den Betreiber aktiviert werden.</div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="tab">
      <div class="grid md:grid-cols-3 gap-4">
        <div class="md:col-span-2 card p-5">
          <h2 class="text-lg font-bold text-cyan-300">Meine Bestellungen</h2>
          <div id="orders" class="mt-3 space-y-2"></div>
        </div>
        <div class="card p-5">
          <h3 class="font-semibold text-cyan-300">Übersicht</h3>
          <div class="mt-2 text-sm">
            <div class="flex justify-between"><span class="text-gray-400">Gesamtzahlungen</span><span class="font-mono" id="sumSpent">0 ETH</span></div>
            <div class="flex justify-between"><span class="text-gray-400">VIP‑Status</span><span id="vipLabel" class="font-mono">Nein</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="admin" class="tab">
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-bold text-cyan-300">Admin</h2>
          <div class="chip">Nur Betreiber‑Wallet</div>
        </div>
        <div class="grid md:grid-cols-2 gap-4 mt-3">
          <div class="card p-4">
            <h3 class="font-semibold mb-2">Bestellungen</h3>
            <div id="adminOrders" class="overflow-x-auto text-sm"></div>
          </div>
          <div class="card p-4">
            <h3 class="font-semibold mb-2">Aktionen</h3>
            <div class="space-y-3">
              <div>
                <div class="text-xs text-gray-400 mb-1">Order-ID</div>
                <input id="admOrderId" class="w-full bg-gray-900 border border-gray-700 rounded p-2 font-mono" placeholder="Firestore-Dokument-ID">
              </div>
              <div class="grid grid-cols-3 gap-2">
                <button class="btn btn-primary w-full" onclick="admActivate()">Aktivieren</button>
                <button class="btn btn-ghost w-full" onclick="admExpire()">Beenden</button>
                <button class="btn btn-ghost w-full" onclick="admCancel()">Stornieren</button>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <button class="btn btn-primary w-full" onclick="admCredit()">Gutschrift</button>
                <button class="btn btn-ghost w-full" onclick="admExtend()">Verlängern</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER with three distributed links -->
  <footer class="p-6 bg-gray-900/80 backdrop-blur border-t border-gray-800 text-gray-400 text-sm mt-2">
    <div class="max-w-6xl mx-auto px-4">
      <div class="flex justify-between items-center">
        <button onclick="openModal('impressumModal')" class="text-blue-300 hover:underline">Impressum</button>
        <button onclick="openModal('agbModal')" class="text-blue-300 hover:underline">AGB</button>
        <button onclick="openModal('datenschutzModal')" class="text-blue-300 hover:underline">Datenschutz</button>
      </div>
      <p class="mt-2 text-center text-xs text-gray-500">© 2025 Hashcore – Alle Rechte vorbehalten</p>
    </div>
  </footer>

  <!-- MODALS -->
  <div id="impressumModal" class="modal fixed inset-0 bg-black/70 items-center justify-center">
    <div class="bg-gray-900 p-6 rounded-xl max-w-lg mx-3 border border-gray-700">
      <h3 class="text-xl font-bold mb-2">Impressum</h3>
      <p>Hashcore<br>Dorfstrasse 233<br>3432 Schwanden i.E<br>Schweiz</p>
      <p class="mt-2">E‑Mail: <a href="mailto:jaun190@gmail.com" class="text-cyan-300">jaun190@gmail.com</a></p>
      <button onclick="closeModal('impressumModal')" class="mt-4 btn btn-primary">Schließen</button>
    </div>
  </div>

  <div id="agbModal" class="modal fixed inset-0 bg-black/70 items-center justify-center">
    <div class="bg-gray-900 p-6 rounded-xl max-w-lg mx-3 border border-gray-700">
      <h3 class="text-xl font-bold mb-2">Allgemeine Geschäftsbedingungen (AGB)</h3>
      <p class="text-gray-200">Mit der Bestellung eines Hashpower‑Pakets akzeptieren Sie unsere allgemeinen Geschäftsbedingungen. Hashcore vermittelt ausschließlich Rechenleistung (Hashrate). Es handelt sich nicht um Finanzprodukte oder Anlageberatung. Gewinne oder Mining‑Erträge werden nicht garantiert, sondern ergeben sich aus den jeweiligen Mining‑Pools. Der Kunde trägt die Verantwortung für die Auswahl seiner Wallet‑ und Pool‑Adressen.</p>
      <button onclick="closeModal('agbModal')" class="mt-4 btn btn-primary">Schließen</button>
    </div>
  </div>

  <div id="datenschutzModal" class="modal fixed inset-0 bg-black/70 items-center justify-center">
    <div class="bg-gray-900 p-6 rounded-xl max-w-lg mx-3 border border-gray-700">
      <h3 class="text-xl font-bold mb-2">Datenschutzerklärung</h3>
      <p class="text-gray-200">Wir speichern nur die für die Abwicklung notwendigen Daten (Wallet‑Adresse, Bestellungen, Status). Es werden keine personenbezogenen Daten wie Name oder Adresse erhoben. Die Datenverarbeitung erfolgt ausschließlich über Firebase/Firestore. Eine Weitergabe an Dritte findet nicht statt, außer soweit zur Vertragserfüllung notwendig.</p>
      <button onclick="closeModal('datenschutzModal')" class="mt-4 btn btn-primary">Schließen</button>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, getDoc, getDocs,
      updateDoc, onSnapshot, serverTimestamp, query, where, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDD2Oo7F-68An2esILVDnfmga1nM-OPKcw",
      authDomain: "yeah-e9c83.firebaseapp.com",
      projectId: "yeah-e9c83",
      storageBucket: "yeah-e9c83.firebasestorage.app",
      messagingSenderId: "94111647513",
      appId: "1:94111647513:web:c4b0596d01a9eaf7c4a788"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const OWNER_WALLET = "0xcb165aF669733864F27070454Ac6C37deC991fFD".toLowerCase();
    const state = { wallet:null, isAdmin:false, chainId:null, myOrders:[] };

    const $ = (id)=>document.getElementById(id);
    const shopEl = $("shopContent");
    const ordersEl = $("orders");

    // Tabs
    function navTo(id){
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      if(id==="admin") refreshAdmin();
    }
    window.navTo = navTo;

    // Modals
    function setModal(id,show){ const m=$(id); if(!m) return; m.classList.toggle("show", !!show); }
    window.openModal=(id)=>setModal(id,true);
    window.closeModal=(id)=>setModal(id,false);

    // MetaMask
    const ethereum = window.ethereum;
    function updateChainUI(){
      const isMainnet = state.chainId === "0x1";
      $("bannerNetwork").classList.toggle("hidden", isMainnet || !state.wallet);
      $("chainStatus").textContent = state.chainId ? `Chain: ${state.chainId}` : "";
    }
    async function ensureMainnet(){
      try{ await ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId:"0x1" }] }); }
      catch(e){ console.warn("switch chain failed", e); }
    }
    $("btnSwitchChain").onclick = ensureMainnet;

    function showConnect(show){
      $("btnConnect").classList.toggle("hidden", !show);
      $("btnDisconnect").classList.toggle("hidden", show);
    }

    async function connectWallet(){
      if(!ethereum){ $("bannerNoMM").classList.remove("hidden"); return; }
      try{
        const accs = await ethereum.request({ method:"eth_requestAccounts" });
        state.wallet = accs[0];
        state.chainId = await ethereum.request({ method:"eth_chainId" });
        state.isAdmin = state.wallet?.toLowerCase()===OWNER_WALLET;
        $("walletStatus").textContent = state.wallet;
        $("adminTab").classList.toggle("hidden", !state.isAdmin);
        $("ethTo").textContent = OWNER_WALLET;
        showConnect(false);
        updateChainUI();
        renderShop();
        watchOrders();
      }catch(e){
        console.error(e); $("walletStatus").textContent="nicht verbunden"; showConnect(true);
      }
    }
    function disconnectWallet(){
      state.wallet=null; $("walletStatus").textContent="nicht verbunden";
      $("adminTab").classList.add("hidden"); showConnect(true);
      shopEl.innerHTML="Bitte mit Wallet verbinden…"; ordersEl.innerHTML="";
    }
    window.connectWallet = connectWallet;
    window.disconnectWallet = disconnectWallet;

    // Init detection
    if(!ethereum){
      $("bannerNoMM").classList.remove("hidden"); showConnect(true);
    }else{
      ethereum.request({ method:"eth_accounts" }).then(accs=>{ if(accs?.length) connectWallet(); else showConnect(true); });
      ethereum.request({ method:"eth_chainId" }).then(cid=>{ state.chainId=cid; updateChainUI(); });
      ethereum.on?.("accountsChanged", (accs)=>{ if(!accs.length){ disconnectWallet(); return; } state.wallet=accs[0]; $("walletStatus").textContent=state.wallet; state.isAdmin=state.wallet.toLowerCase()===OWNER_WALLET; $("adminTab").classList.toggle("hidden", !state.isAdmin); renderShop(); watchOrders(); });
      ethereum.on?.("chainChanged", (cid)=>{ state.chainId=cid; updateChainUI(); });
    }

    // Shop
    const PKGS=[
      { id:"p1", name:"Micro 10 MH/s · 24h", priceEth:"0.01" },
      { id:"p2", name:"Pro 50 MH/s · 3 Tage", priceEth:"0.05" },
      { id:"p3", name:"Elite 200 MH/s · 7 Tage", priceEth:"0.2" }
    ];

    function renderShop(){
      if(!state.wallet){ shopEl.textContent="Bitte mit Wallet verbinden…"; return; }
      shopEl.innerHTML="";
      PKGS.forEach(p=>{
        const div=document.createElement("div");
        div.className="card p-4";
        div.innerHTML=`
          <div class="flex items-start justify-between">
            <div class="font-semibold">${p.name}</div>
            <div class="chip">${p.priceEth} ETH</div>
          </div>
          <div class="text-xs text-gray-400 mt-1">Preis inkl. Servicegebühr</div>
          <button class="btn btn-primary mt-3">Kaufen</button>`;
        div.querySelector("button").onclick=()=>buy(p);
        shopEl.appendChild(div);
      });
    }

    function toWeiHexSafe(ethStr){
      const [ints,decs=""] = String(ethStr).split(".");
      const decPad = (decs + "000000000000000000").slice(0,18);
      const wei = BigInt(ints||"0")*10n**18n + BigInt(decPad||"0");
      return "0x"+wei.toString(16);
    }

    async function buy(pkg){
      if(!state.wallet || !ethereum){ return alert("Bitte zuerst Wallet verbinden."); }
      try{
        const txHash = await ethereum.request({
          method:"eth_sendTransaction",
          params:[{ from:state.wallet, to:OWNER_WALLET, value: toWeiHexSafe(pkg.priceEth) }]
        }).catch(async e=>{
          console.warn("hex failed, retry decimal", e);
          // decimal fallback
          const parts = String(pkg.priceEth).split(".");
          const wei = BigInt(parts[0]||"0")*10n**18n + BigInt((parts[1]||"").padEnd(18,"0"));
          return await ethereum.request({ method:"eth_sendTransaction", params:[{ from:state.wallet, to:OWNER_WALLET, value: wei.toString() }] });
        });

        await addDoc(collection(db,"orders"),{
          wallet: state.wallet, package: pkg.name, price: parseFloat(pkg.priceEth),
          status: "client_paid", tx: txHash, createdAt: serverTimestamp()
        });

        alert("Bestellung eingetragen! TX: "+txHash);
      }catch(e){ console.error(e); alert("Zahlung abgebrochen oder fehlgeschlagen."); }
    }

    // Dashboard
    function watchOrders(){
      if(!state.wallet) return;
      const q=query(collection(db,"orders"),where("wallet","==",state.wallet),orderBy("createdAt","desc"));
      onSnapshot(q,snap=>{
        state.myOrders = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        ordersEl.innerHTML="";
        let spent=0;
        state.myOrders.forEach(o=>{
          spent += o.price || 0;
          const tx = o.tx ? `<a class="text-cyan-300 font-mono" target="_blank" href="https://etherscan.io/tx/${o.tx}">${String(o.tx).slice(0,10)}…</a>` : "-";
          const row=document.createElement("div");
          row.className="card p-3";
          row.innerHTML=`<div class="flex items-center justify-between">
            <div><div class="font-semibold">${o.package}</div><div class="text-xs text-gray-400">${o.price} ETH • Status: ${o.status}</div></div>
            <div>${tx}</div>
          </div>`;
          ordersEl.appendChild(row);
        });
        $("sumSpent").textContent = spent.toFixed(6) + " ETH";
        const vip = spent >= 0.5;
        $("vipLabel").textContent = vip ? "Ja" : "Nein";
        $("vipBadge").classList.toggle("hidden", !vip);
      });
    }

    // Admin
    async function refreshAdmin(){
      if(!state.isAdmin)return;
      const q=query(collection(db,"orders"),orderBy("createdAt","desc"),limit(50));
      const snap=await getDocs(q);
      const cont=$("adminOrders"); cont.innerHTML="";
      const rows = snap.docs.map(d=>{
        const o=d.data();
        const tx=o.tx?`<a class="text-cyan-300 font-mono" target="_blank" href="https://etherscan.io/tx/${o.tx}">${String(o.tx).slice(0,10)}…</a>`:"-";
        return `<tr>
          <td class="px-2 py-1 font-mono text-xs">${d.id}</td>
          <td class="px-2 py-1 font-mono text-xs">${o.wallet?.slice(0,8)}…</td>
          <td class="px-2 py-1">${o.package}</td>
          <td class="px-2 py-1 font-mono text-xs">${o.price} ETH</td>
          <td class="px-2 py-1">${o.status}</td>
          <td class="px-2 py-1">${tx}</td>
        </tr>`;
      }).join("");
      cont.innerHTML = `<table class="min-w-full">
        <thead class="text-xs text-gray-400"><tr>
          <th class="text-left px-2 py-1">ID</th><th class="text-left px-2 py-1">Wallet</th><th class="text-left px-2 py-1">Paket</th>
          <th class="text-left px-2 py-1">Preis</th><th class="text-left px-2 py-1">Status</th><th class="text-left px-2 py-1">Tx</th>
        </tr></thead>
        <tbody>${rows || '<tr><td class="px-2 py-3 text-gray-500" colspan="6">Keine Bestellungen.</td></tr>'}</tbody>
      </table>`;
    }
    window.admActivate=async()=>{ const id=$("admOrderId").value.trim(); if(!id)return alert("Order-ID eingeben."); await updateDoc(doc(db,"orders",id),{status:"active",activatedAt:serverTimestamp()}); alert("Aktiviert."); refreshAdmin(); };
    window.admExpire=async()=>{ const id=$("admOrderId").value.trim(); if(!id)return alert("Order-ID eingeben."); await updateDoc(doc(db,"orders",id),{status:"expired",expiredAt:serverTimestamp()}); alert("Beendet."); refreshAdmin(); };
    window.admCredit=async()=>{ const id=$("admOrderId").value.trim(); if(!id)return alert("Order-ID eingeben."); const amount=prompt("ETH-Gutschrift (Info-Feld):"); await updateDoc(doc(db,"orders",id),{credited:(parseFloat(amount)||0)}); alert("Gutschrift gesetzt."); refreshAdmin(); };
    window.admExtend=async()=>{ const id=$("admOrderId").value.trim(); if(!id)return alert("Order-ID eingeben."); const days=prompt("Tage verlängern (Info-Feld):"); await updateDoc(doc(db,"orders",id),{extendDays:(parseInt(days)||0)}); alert("Verlängerung gesetzt."); refreshAdmin(); };
    window.admCancel=async()=>{
      const id=$("admOrderId").value.trim(); if(!id)return alert("Order-ID eingeben.");
      const ref=doc(db,"orders",id); const snap=await getDoc(ref); if(!snap.exists())return alert("Order nicht gefunden.");
      const o=snap.data();
      if(o.status==="awaiting_payment"){ await updateDoc(ref,{status:"cancelled",cancelledAt:serverTimestamp()}); alert("Bestellung storniert (nicht bezahlt)."); }
      else if(o.status==="client_paid"){ await updateDoc(ref,{status:"refunded",refundedAt:serverTimestamp()}); alert("Als erstattet markiert (on‑chain Erstattung separat durchführen)."); }
      else if(o.status==="active"){ alert("Aktive Pakete erst beenden, dann stornieren."); }
      else { await updateDoc(ref,{status:"cancelled",cancelledAt:serverTimestamp()}); alert("Bestellung storniert."); }
      refreshAdmin();
    };
  </script>
</body>
</html>
