<!DOCTYPE html><html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pool Control — Ultra UI</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        fontFamily: { sans: ["Inter", "ui-sans-serif", "system-ui"] },
        extend: {
          colors: {
            bg: { 900: "#07090F", 800: "#0B0F1A", 700: "#0F1625", 600: "#111B2D" },
            glass: "rgba(255,255,255,0.06)",
            neon: { 300: "#9CFFF6", 400: "#7DF9FF", 500: "#41E8F0", 600: "#1EC6D1" },
            violet: { 500: "#8B5CF6" }
          },
          boxShadow: {
            glass: "0 8px 32px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06)",
            neon: "0 0 0 1px rgba(125,249,255,.25), 0 8px 24px rgba(65,232,240,.18)",
            card: "0 10px 30px rgba(0,0,0,.45)"
          },
          transitionTimingFunction: { bounce: "cubic-bezier(.2, .8, .2, 1)" }
        }
      }
    }
  </script>
  <style>
    html,body{height:100%}
    body{background:
      radial-gradient(1200px 600px at 10% -10%, rgba(65,232,240,.14), transparent),
      radial-gradient(800px 500px at 90% 10%, rgba(146,83,255,.12), transparent),
      linear-gradient(180deg,#07090F,#0B0F1A 40%,#0F1625)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); backdrop-filter: blur(10px)}
    .btn{transition: transform .06s ease, box-shadow .2s ease}
    .btn:active{transform: translateY(1px)}
    .grad-text{background: linear-gradient(90deg,#7DF9FF,#B9A4FF); -webkit-background-clip: text; background-clip: text; color: transparent}
    .kbd{border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06)}
    .shine{position:relative;overflow:hidden}
    .shine::after{content:"";position:absolute;inset:-40%;background: conic-gradient(from 0deg, transparent 0 35%, rgba(255,255,255,.12) 40%, transparent 45%);animation:spin 8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body class="text-white font-sans">
  <!-- Top Bar -->
  <div class="sticky top-0 z-40 border-b border-white/10 bg-bg-900/70 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-4">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl shine" style="box-shadow:0 0 0 1px rgba(125,249,255,.35), inset 0 0 30px rgba(125,249,255,.08)"></div>
        <div>
          <div class="text-xs uppercase tracking-widest text-white/60">Pool Control</div>
          <h1 class="text-xl font-extrabold grad-text leading-5">Ultra UI</h1>
        </div>
      </div>
      <div class="flex-1"></div>
      <div class="hidden sm:flex items-center gap-2">
        <input id="apiBase" class="w-80 px-3.5 py-2.5 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-neon-500/50" placeholder="API‑URL (z. B. http://IP:8080)"/>
        <button id="btnConnect" class="btn px-4 py-2.5 rounded-xl bg-neon-600 text-black font-semibold shadow-neon hover:brightness-110">Verbinden</button>
      </div>
      <button id="openConnect" class="sm:hidden btn px-3 py-2 rounded-xl bg-neon-600 text-black font-semibold shadow-neon">Verbinden</button>
    </div>
  </div>  <main class="max-w-7xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-4">
    <!-- Wizard / Tips -->
    <aside class="lg:col-span-4 xl:col-span-3 card rounded-2xl shadow-card p-4">
      <h2 class="text-lg font-semibold mb-2">Schnellstart</h2>
      <ol class="space-y-3 text-sm text-white/80">
        <li class="p-3 rounded-xl bg-white/5 border border-white/10">
          <div class="font-medium">1. API verbinden</div>
          <div class="text-white/70">Proxy läuft? Trage oben <span class="kbd px-1.5 py-0.5 rounded">http://SERVER:8080</span> ein und klick <b>Verbinden</b>.</div>
        </li>
        <li class="p-3 rounded-xl bg-white/5 border border-white/10">
          <div class="font-medium">2. Upstreams anlegen</div>
          <div class="text-white/70">Füge deine Pools hinzu (Host/Port). Aktiviere/Deaktiviere per Schalter.</div>
        </li>
        <li class="p-3 rounded-xl bg-white/5 border border-white/10">
          <div class="font-medium">3. Listener routen</div>
          <div class="text-white/70">Modus <b>Primary + Failover</b> oder <b>Weighted</b> wählen, danach <b>Übernehmen</b>.</div>
        </li>
      </ol><div class="mt-4 p-4 rounded-2xl bg-bg-600/60 border border-white/10">
    <div class="text-sm font-semibold mb-1">Upstream hinzufügen</div>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
      <input id="newName" placeholder="Name" class="px-3 py-2 bg-white/5 border border-white/10 rounded-xl"/>
      <input id="newHost" placeholder="Host (eu.pool.com)" class="px-3 py-2 bg-white/5 border border-white/10 rounded-xl"/>
      <input id="newPort" placeholder="Port" type="number" class="px-3 py-2 bg-white/5 border border-white/10 rounded-xl"/>
    </div>
    <button id="btnAddUp" class="mt-2 w-full btn px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15">Hinzufügen</button>
  </div>

  <div class="mt-4 p-4 rounded-2xl bg-bg-600/60 border border-white/10 flex items-center justify-between">
    <div>
      <div class="text-sm font-semibold">Live‑Autorefresh</div>
      <div class="text-xs text-white/60">Aktualisiert /metrics & /config alle 3s</div>
    </div>
    <label class="inline-flex items-center cursor-pointer select-none">
      <input id="autorefresh" type="checkbox" class="sr-only peer">
      <span class="w-12 h-6 bg-white/10 rounded-full peer-checked:bg-neon-600 relative transition"><span class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full peer-checked:translate-x-6 transition"></span></span>
    </label>
  </div>

  <button id="btnSave" class="mt-4 w-full btn px-4 py-2 rounded-xl bg-neon-600 text-black font-semibold shadow-neon hover:brightness-110">Konfiguration speichern</button>
</aside>

<!-- Listeners -->
<section class="lg:col-span-8 xl:col-span-9 space-y-4">
  <div class="card rounded-2xl shadow-card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">Listener</h2>
      <div class="text-sm text-white/60">Ports & Routing</div>
    </div>
    <div id="listeners" class="space-y-3"></div>
    <div id="listenersEmpty" class="hidden text-sm text-white/60">Keine Listener geladen. Ist die API verbunden?</div>
  </div>

  <!-- Upstreams -->
  <div class="card rounded-2xl shadow-card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">Upstreams</h2>
      <div class="text-sm text-white/60">Aktivieren, Bearbeiten, Gewichte</div>
    </div>
    <div id="upstreams" class="space-y-3"></div>
    <div id="upstreamsEmpty" class="hidden text-sm text-white/60">Noch keine Upstreams. Lege oben welche an.</div>
  </div>

  <!-- Sessions / Metrics -->
  <div class="card rounded-2xl shadow-card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">Live‑Sessions</h2>
      <div class="text-sm text-white/60" id="since"></div>
    </div>
    <div id="sessions" class="space-y-2 max-h-[420px] overflow-auto"></div>
  </div>
</section>

  </main>  <!-- Mobile Connect Dialog -->  <div id="connectDlg" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4">
    <div class="card rounded-2xl shadow-card p-4 w-full max-w-md">
      <h3 class="text-lg font-semibold mb-2">Mit API verbinden</h3>
      <input id="apiBaseMobile" class="w-full px-3.5 py-2.5 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-neon-500/50" placeholder="http://SERVER:8080"/>
      <div class="flex gap-2 mt-3">
        <button id="btnConnectMobile" class="flex-1 btn px-4 py-2.5 rounded-xl bg-neon-600 text-black font-semibold shadow-neon">Verbinden</button>
        <button id="btnCloseMobile" class="flex-1 btn px-4 py-2.5 rounded-xl bg-white/10 hover:bg-white/15">Abbrechen</button>
      </div>
    </div>
  </div>  <!-- Toast -->  <div id="toast" class="fixed bottom-4 right-4 px-4 py-2 rounded-xl bg-neon-600 text-black shadow-neon hidden">Gespeichert ✓</div>  <script>
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    const state = { api: localStorage.getItem('apiBase') || '', config: null, metrics: null, timer: null };
    const apiInput = $('#apiBase');
    if (apiInput) apiInput.value = state.api;

    function showToast(msg, ok=true){
      const t = $('#toast');
      t.textContent = msg;
      t.className = `fixed bottom-4 right-4 px-4 py-2 rounded-xl ${ok? 'bg-neon-600 text-black':'bg-red-500 text-white'} shadow-neon`;
      t.classList.remove('hidden');
      setTimeout(()=>t.classList.add('hidden'), 2200);
    }

    async function api(path, opts={}){
      const base = state.api.replace(/\/$/, '');
      if (!base) throw new Error('API‑Basis ist leer');
      const res = await fetch(base + path, Object.assign({ headers: { 'Content-Type':'application/json' } }, opts));
      if (!res.ok) throw new Error((await res.text())||('HTTP '+res.status));
      const ct = res.headers.get('content-type')||'';
      return ct.includes('application/json')? res.json(): res.text();
    }

    const fmtBytes = (v)=> v>1e9? (v/1e9).toFixed(2)+' GB' : v>1e6? (v/1e6).toFixed(2)+' MB' : v>1e3? (v/1e3).toFixed(2)+' kB' : v+' B';
    const pill = (txt, tone='ok') => {
      const c = tone==='ok' ? 'bg-emerald-500/20 text-emerald-200 border-emerald-400/30' : tone==='warn' ? 'bg-yellow-500/20 text-yellow-200 border-yellow-400/30' : 'bg-red-500/20 text-red-200 border-red-400/30';
      return `<span class="px-2 py-0.5 rounded-lg border ${c} text-xs">${txt}</span>`;
    };

    function renderListeners(){
      const wrap = $('#listeners');
      const cfg = state.config; if (!cfg) return;
      wrap.innerHTML = '';
      if (!cfg.listeners?.length){ $('#listenersEmpty').classList.remove('hidden'); return; } else { $('#listenersEmpty').classList.add('hidden'); }
      cfg.listeners.forEach(l => {
        const isWeighted = l.mode === 'weighted';
        const upstreamOpts = (state.config.upstreams||[]).map(u=>`<option value="${u.id}">${u.name} (${u.host}:${u.port})</option>`).join('');
        const weights = (state.config.weighted?.[l.id]||[]).map(w => {
          const u = state.config.upstreams.find(x=>x.id===w.upstream_id);
          return `<div class="flex items-center gap-2">${u? `${u.name}`:'?'}<input data-lid="${l.id}" data-uid="${w.upstream_id}" class="w-24 px-2 py-1 bg-white/5 border border-white/10 rounded-lg weight-input" type="number" min="0" value="${w.weight||0}"/>%</div>`;
        }).join('');

        const card = document.createElement('div');
        card.className = 'p-4 rounded-xl bg-white/5 border border-white/10';
        card.innerHTML = `
          <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-3">
            <div>
              <div class="font-semibold text-white/90">${l.name}</div>
              <div class="text-sm text-white/60">${l.host}:${l.port}</div>
            </div>
            <div class="flex flex-wrap items-center gap-2">
              <select data-lid="${l.id}" class="modeSel px-3 py-2 bg-white/5 border border-white/10 rounded-xl">
                <option value="primary" ${!isWeighted?'selected':''}>Primary + Failover</option>
                <option value="weighted" ${isWeighted?'selected':''}>Weighted</option>
              </select>
              <div class="flex items-center gap-2 ${isWeighted?'hidden':''}" id="pf-${l.id}">
                <label class="text-sm text-white/60">Primary</label>
                <select class="px-3 py-2 bg-white/5 border border-white/10 rounded-xl primarySel" data-lid="${l.id}">
                  ${upstreamOpts}
                </select>
                <label class="text-sm text-white/60">Failover</label>
                <select multiple size="1" class="px-3 py-2 bg-white/5 border border-white/10 rounded-xl failoverSel" data-lid="${l.id}">
                  ${upstreamOpts}
                </select>
                <button class="applyPF px-3 py-2 rounded-xl bg-neon-600 text-black">Übernehmen</button>
              </div>
              <div class="${isWeighted?'':'hidden'} flex items-center gap-3 w-full lg:w-auto" id="wg-${l.id}">
                <div class="flex flex-col gap-1 w-full lg:w-auto">${weights || '<div class="text-sm text-white/60">Keine Gewichte definiert</div>'}</div>
                <button class="applyWG px-3 py-2 rounded-xl bg-neon-600 text-black" data-lid="${l.id}">Speichern</button>
              </div>
            </div>
          </div>`;
        wrap.appendChild(card);

        const pSel = card.querySelector('.primarySel');
        if (pSel && l.primary_upstream_id) pSel.value = l.primary_upstream_id;
        const fSel = card.querySelector('.failoverSel');
        if (fSel && Array.isArray(l.failover_upstream_ids)) Array.from(fSel.options).forEach(o => { o.selected = l.failover_upstream_ids.includes(o.value); });

        card.querySelector('.modeSel').addEventListener('change', async (e)=>{
          const mode = e.target.value; await api(`/listeners/${l.id}/mode`, { method:'POST', body: JSON.stringify({ mode })}); await refresh();
        });
        const btnPF = card.querySelector('.applyPF');
        if (btnPF) btnPF.addEventListener('click', async ()=>{
          const primary_upstream_id = pSel.value;
          const failover_upstream_ids = Array.from(fSel.selectedOptions).map(o=>o.value);
          await api(`/listeners/${l.id}/mode`, { method:'POST', body: JSON.stringify({ mode:'primary', primary_upstream_id, failover_upstream_ids })});
          showToast('Listener aktualisiert'); await refresh();
        });
        const btnWG = card.querySelector('.applyWG');
        if (btnWG) btnWG.addEventListener('click', async ()=>{
          const inputs = $$('.weight-input', card);
          const arr = inputs.map(inp => ({ upstream_id: inp.dataset.uid, weight: Number(inp.value||0) }));
          state.config.weighted = state.config.weighted || {}; state.config.weighted[l.id] = arr;
          await api('/save', { method:'POST' }); showToast('Gewichte gespeichert'); await refresh();
        });
      });
    }

    function renderUpstreams(){
      const wrap = $('#upstreams');
      wrap.innerHTML = '';
      const list = state.config?.upstreams || [];
      if (!list.length){ $('#upstreamsEmpty').classList.remove('hidden'); return; } else { $('#upstreamsEmpty').classList.add('hidden'); }
      list.forEach(u => {
        const status = state.metrics?.upstreams?.find(x=>x.id===u.id)?.status || null;
        const ok = status?.ok;
        const card = document.createElement('div'); card.className = 'p-4 rounded-xl bg-white/5 border border-white/10';
        card.innerHTML = `
          <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-3">
            <div>
              <div class="font-semibold">${u.name} ${ok? pill('OK','ok') : status? pill('Fehler','bad'): pill('unbekannt','warn')}</div>
              <div class="text-sm text-white/70">${u.host}:${u.port}</div>
            </div>
            <div class="flex flex-wrap items-center gap-2">
              <label class="text-sm text-white/70">Aktiv</label>
              <input type="checkbox" class="toggleU scale-125" ${u.enabled? 'checked':''} />
              <input type="text" class="px-3 py-2 bg-white/5 border border-white/10 rounded-xl hostInp" value="${u.host}"/>
              <input type="number" class="w-24 px-3 py-2 bg-white/5 border border-white/10 rounded-xl portInp" value="${u.port}"/>
              <button class="saveU px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15">Speichern</button>
            </div>
          </div>`;
        wrap.appendChild(card);
        const toggle = card.querySelector('.toggleU');
        const hostInp = card.querySelector('.hostInp');
        const portInp = card.querySelector('.portInp');
        card.querySelector('.saveU').addEventListener('click', async ()=>{
          await api(`/upstreams/${u.id}`, { method:'PATCH', body: JSON.stringify({ enabled: toggle.checked, host: hostInp.value, port: Number(portInp.value) })});
          showToast('Upstream gespeichert'); await refresh();
        });
      });
    }

    function renderSessions(){
      const wrap = $('#sessions');
      const list = state.metrics?.sessions || [];
      $('#since').textContent = new Date().toLocaleTimeString();
      wrap.innerHTML = '';
      if (list.length === 0){ wrap.innerHTML = '<div class="text-white/60 text-sm">Noch keine aktiven Sessions.</div>'; return; }
      list.forEach(s => {
        const row = document.createElement('div'); row.className = 'flex items-center justify-between gap-3 p-3 rounded-lg bg-white/5 border border-white/10';
        row.innerHTML = `
          <div class="text-xs text-white/70">${s.sessionId.slice(0,8)}…</div>
          <div class="text-sm">Listener: <span class="text-white/80">${s.listenerId}</span></div>
          <div class="text-sm">Upstream: <span class="text-white/80">${s.upstreamId}</span></div>
          <div class="text-sm">↑ ${fmtBytes(s.bytesUp)} · ↓ ${fmtBytes(s.bytesDown)}</div>
          <div class="text-sm text-white/70">${s.ageSec}s</div>`;
        wrap.appendChild(row);
      });
    }

    async function refresh(){
      try {
        state.config = await api('/config');
        state.metrics = await api('/metrics');
        renderListeners(); renderUpstreams(); renderSessions();
      } catch (e) { showToast('Fehler: '+e.message, false); }
    }

    // actions
    $('#btnConnect')?.addEventListener('click', async ()=>{ state.api = $('#apiBase').value.trim(); localStorage.setItem('apiBase', state.api); await refresh(); });
    $('#btnSave')?.addEventListener('click', async ()=>{ try { await api('/save', { method:'POST' }); showToast('Konfiguration gespeichert'); } catch(e){ showToast('Fehler: '+e.message, false);} });
    $('#btnAddUp')?.addEventListener('click', async ()=>{ try { const name = $('#newName').value.trim(); const host = $('#newHost').value.trim(); const port = Number($('#newPort').value.trim()); if (!name||!host||!port) return showToast('Bitte Name/Host/Port füllen', false); await api('/upstreams', { method:'POST', body: JSON.stringify({ name, host, port })}); ['#newName','#newHost','#newPort'].forEach(s=>$(s).value=''); showToast('Upstream angelegt'); await refresh(); } catch (e) { showToast('Fehler: '+e.message, false);} });
    $('#autorefresh')?.addEventListener('change', (e)=>{ if (e.target.checked){ state.timer = setInterval(refresh, 3000); } else { clearInterval(state.timer); state.timer = null; }});

    // mobile dialog
    $('#openConnect')?.addEventListener('click', ()=>{ $('#connectDlg').classList.remove('hidden'); $('#connectDlg').classList.add('flex'); });
    $('#btnCloseMobile')?.addEventListener('click', ()=>{ $('#connectDlg').classList.add('hidden'); $('#connectDlg').classList.remove('flex'); });
    $('#btnConnectMobile')?.addEventListener('click', async ()=>{ state.api = $('#apiBaseMobile').value.trim(); localStorage.setItem('apiBase', state.api); $('#connectDlg').classList.add('hidden'); $('#connectDlg').classList.remove('flex'); await refresh(); });

    // Auto-connect
    if (state.api) refresh();
  </script></body>
</html>
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pool Control — Ultra UI</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        fontFamily: { sans: ["Inter", "ui-sans-serif", "system-ui"] },
        extend: {
          colors: {
            bg: { 900: "#07090F", 800: "#0B0F1A", 700: "#0F1625", 600: "#111B2D" },
            glass: "rgba(255,255,255,0.06)",
            neon: { 300: "#9CFFF6", 400: "#7DF9FF", 500: "#41E8F0", 600: "#1EC6D1" },
            violet: { 500: "#8B5CF6" }
          },
          boxShadow: {
            glass: "0 8px 32px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06)",
            neon: "0 0 0 1px rgba(125,249,255,.25), 0 8px 24px rgba(65,232,240,.18)",
            card: "0 10px 30px rgba(0,0,0,.45)"
          },
          transitionTimingFunction: { bounce: "cubic-bezier(.2, .8, .2, 1)" }
        }
      }
    }
  </script>
  <style>
    html,body{height:100%}
    body{background:
      radial-gradient(1200px 600px at 10% -10%, rgba(65,232,240,.14), transparent),
      radial-gradient(800px 500px at 90% 10%, rgba(146,83,255,.12), transparent),
      linear-gradient(180deg,#07090F,#0B0F1A 40%,#0F1625)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); backdrop-filter: blur(10px)}
    .btn{transition: transform .06s ease, box-shadow .2s ease}
    .btn:active{transform: translateY(1px)}
    .grad-text{background: linear-gradient(90deg,#7DF9FF,#B9A4FF); -webkit-background-clip: text; background-clip: text; color: transparent}
    .kbd{border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06)}
    .shine{position:relative;overflow:hidden}
    .shine::after{content:"";position:absolute;inset:-40%;background: conic-gradient(from 0deg, transparent 0 35%, rgba(255,255,255,.12) 40%, transparent 45%);animation:spin 8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body class="text-white font-sans">
  <!-- Top Bar -->
  <div class="sticky top-0 z-40 border-b border-white/10 bg-bg-900/70 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-4">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl shine" style="box-shadow:0 0 0 1px rgba(125,249,255,.35), inset 0 0 30px rgba(125,249,255,.08)"></div>
        <div>
          <div class="text-xs uppercase tracking-widest text-white/60">Pool Control</div>
          <h1 class="text-xl font-extrabold grad-text leading-5">Ultra UI</h1>
        </div>
      </div>
      <div class="flex-1"></div>
      <div class="hidden sm:flex items-center gap-2">
        <input id="apiBase" class="w-80 px-3.5 py-2.5 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-neon-500/50" placeholder="API‑URL (z. B. http://IP:8080)"/>
        <button id="btnConnect" class="btn px-4 py-2.5 rounded-xl bg-neon-600 text-black font-semibold shadow-neon hover:brightness-110">Verbinden</button>
      </div>
      <button id="openConnect" class="sm:hidden btn px-3 py-2 rounded-xl bg-neon-600 text-black font-semibold shadow-neon">Verbinden</button>
    </div>
  </div>  <main class="max-w-7xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-4">
    <!-- Wizard / Tips -->
    <aside class="lg:col-span-4 xl:col-span-3 card rounded-2xl shadow-card p-4">
      <h2 class="text-lg font-semibold mb-2">Schnellstart</h2>
      <ol class="space-y-3 text-sm text-white/80">
        <li class="p-3 rounded-xl bg-white/5 border border-white/10">
          <div class="font-medium">1. API verbinden</div>
          <div class="text-white/70">Proxy läuft? Trage oben <span class="kbd px-1.5 py-0.5 rounded">http://SERVER:8080</span> ein und klick <b>Verbinden</b>.</div>
        </li>
        <li class="p-3 rounded-xl bg-white/5 border border-white/10">
          <div class="font-medium">2. Upstreams anlegen</div>
          <div class="text-white/70">Füge deine Pools hinzu (Host/Port). Aktiviere/Deaktiviere per Schalter.</div>
        </li>
        <li class="p-3 rounded-xl bg-white/5 border border-white/10">
          <div class="font-medium">3. Listener routen</div>
          <div class="text-white/70">Modus <b>Primary + Failover</b> oder <b>Weighted</b> wählen, danach <b>Übernehmen</b>.</div>
        </li>
      </ol><div class="mt-4 p-4 rounded-2xl bg-bg-600/60 border border-white/10">
    <div class="text-sm font-semibold mb-1">Upstream hinzufügen</div>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
      <input id="newName" placeholder="Name" class="px-3 py-2 bg-white/5 border border-white/10 rounded-xl"/>
      <input id="newHost" placeholder="Host (eu.pool.com)" class="px-3 py-2 bg-white/5 border border-white/10 rounded-xl"/>
      <input id="newPort" placeholder="Port" type="number" class="px-3 py-2 bg-white/5 border border-white/10 rounded-xl"/>
    </div>
    <button id="btnAddUp" class="mt-2 w-full btn px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15">Hinzufügen</button>
  </div>

  <div class="mt-4 p-4 rounded-2xl bg-bg-600/60 border border-white/10 flex items-center justify-between">
    <div>
      <div class="text-sm font-semibold">Live‑Autorefresh</div>
      <div class="text-xs text-white/60">Aktualisiert /metrics & /config alle 3s</div>
    </div>
    <label class="inline-flex items-center cursor-pointer select-none">
      <input id="autorefresh" type="checkbox" class="sr-only peer">
      <span class="w-12 h-6 bg-white/10 rounded-full peer-checked:bg-neon-600 relative transition"><span class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full peer-checked:translate-x-6 transition"></span></span>
    </label>
  </div>

  <button id="btnSave" class="mt-4 w-full btn px-4 py-2 rounded-xl bg-neon-600 text-black font-semibold shadow-neon hover:brightness-110">Konfiguration speichern</button>
</aside>

<!-- Listeners -->
<section class="lg:col-span-8 xl:col-span-9 space-y-4">
  <div class="card rounded-2xl shadow-card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">Listener</h2>
      <div class="text-sm text-white/60">Ports & Routing</div>
    </div>
    <div id="listeners" class="space-y-3"></div>
    <div id="listenersEmpty" class="hidden text-sm text-white/60">Keine Listener geladen. Ist die API verbunden?</div>
  </div>

  <!-- Upstreams -->
  <div class="card rounded-2xl shadow-card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">Upstreams</h2>
      <div class="text-sm text-white/60">Aktivieren, Bearbeiten, Gewichte</div>
    </div>
    <div id="upstreams" class="space-y-3"></div>
    <div id="upstreamsEmpty" class="hidden text-sm text-white/60">Noch keine Upstreams. Lege oben welche an.</div>
  </div>

  <!-- Sessions / Metrics -->
  <div class="card rounded-2xl shadow-card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">Live‑Sessions</h2>
      <div class="text-sm text-white/60" id="since"></div>
    </div>
    <div id="sessions" class="space-y-2 max-h-[420px] overflow-auto"></div>
  </div>
</section>

  </main>  <!-- Mobile Connect Dialog -->  <div id="connectDlg" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4">
    <div class="card rounded-2xl shadow-card p-4 w-full max-w-md">
      <h3 class="text-lg font-semibold mb-2">Mit API verbinden</h3>
      <input id="apiBaseMobile" class="w-full px-3.5 py-2.5 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-neon-500/50" placeholder="http://SERVER:8080"/>
      <div class="flex gap-2 mt-3">
        <button id="btnConnectMobile" class="flex-1 btn px-4 py-2.5 rounded-xl bg-neon-600 text-black font-semibold shadow-neon">Verbinden</button>
        <button id="btnCloseMobile" class="flex-1 btn px-4 py-2.5 rounded-xl bg-white/10 hover:bg-white/15">Abbrechen</button>
      </div>
    </div>
  </div>  <!-- Toast -->  <div id="toast" class="fixed bottom-4 right-4 px-4 py-2 rounded-xl bg-neon-600 text-black shadow-neon hidden">Gespeichert ✓</div>  <script>
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    const state = { api: localStorage.getItem('apiBase') || '', config: null, metrics: null, timer: null };
    const apiInput = $('#apiBase');
    if (apiInput) apiInput.value = state.api;

    function showToast(msg, ok=true){
      const t = $('#toast');
      t.textContent = msg;
      t.className = `fixed bottom-4 right-4 px-4 py-2 rounded-xl ${ok? 'bg-neon-600 text-black':'bg-red-500 text-white'} shadow-neon`;
      t.classList.remove('hidden');
      setTimeout(()=>t.classList.add('hidden'), 2200);
    }

    async function api(path, opts={}){
      const base = state.api.replace(/\/$/, '');
      if (!base) throw new Error('API‑Basis ist leer');
      const res = await fetch(base + path, Object.assign({ headers: { 'Content-Type':'application/json' } }, opts));
      if (!res.ok) throw new Error((await res.text())||('HTTP '+res.status));
      const ct = res.headers.get('content-type')||'';
      return ct.includes('application/json')? res.json(): res.text();
    }

    const fmtBytes = (v)=> v>1e9? (v/1e9).toFixed(2)+' GB' : v>1e6? (v/1e6).toFixed(2)+' MB' : v>1e3? (v/1e3).toFixed(2)+' kB' : v+' B';
    const pill = (txt, tone='ok') => {
      const c = tone==='ok' ? 'bg-emerald-500/20 text-emerald-200 border-emerald-400/30' : tone==='warn' ? 'bg-yellow-500/20 text-yellow-200 border-yellow-400/30' : 'bg-red-500/20 text-red-200 border-red-400/30';
      return `<span class="px-2 py-0.5 rounded-lg border ${c} text-xs">${txt}</span>`;
    };

    function renderListeners(){
      const wrap = $('#listeners');
      const cfg = state.config; if (!cfg) return;
      wrap.innerHTML = '';
      if (!cfg.listeners?.length){ $('#listenersEmpty').classList.remove('hidden'); return; } else { $('#listenersEmpty').classList.add('hidden'); }
      cfg.listeners.forEach(l => {
        const isWeighted = l.mode === 'weighted';
        const upstreamOpts = (state.config.upstreams||[]).map(u=>`<option value="${u.id}">${u.name} (${u.host}:${u.port})</option>`).join('');
        const weights = (state.config.weighted?.[l.id]||[]).map(w => {
          const u = state.config.upstreams.find(x=>x.id===w.upstream_id);
          return `<div class="flex items-center gap-2">${u? `${u.name}`:'?'}<input data-lid="${l.id}" data-uid="${w.upstream_id}" class="w-24 px-2 py-1 bg-white/5 border border-white/10 rounded-lg weight-input" type="number" min="0" value="${w.weight||0}"/>%</div>`;
        }).join('');

        const card = document.createElement('div');
        card.className = 'p-4 rounded-xl bg-white/5 border border-white/10';
        card.innerHTML = `
          <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-3">
            <div>
              <div class="font-semibold text-white/90">${l.name}</div>
              <div class="text-sm text-white/60">${l.host}:${l.port}</div>
            </div>
            <div class="flex flex-wrap items-center gap-2">
              <select data-lid="${l.id}" class="modeSel px-3 py-2 bg-white/5 border border-white/10 rounded-xl">
                <option value="primary" ${!isWeighted?'selected':''}>Primary + Failover</option>
                <option value="weighted" ${isWeighted?'selected':''}>Weighted</option>
              </select>
              <div class="flex items-center gap-2 ${isWeighted?'hidden':''}" id="pf-${l.id}">
                <label class="text-sm text-white/60">Primary</label>
                <select class="px-3 py-2 bg-white/5 border border-white/10 rounded-xl primarySel" data-lid="${l.id}">
                  ${upstreamOpts}
                </select>
                <label class="text-sm text-white/60">Failover</label>
                <select multiple size="1" class="px-3 py-2 bg-white/5 border border-white/10 rounded-xl failoverSel" data-lid="${l.id}">
                  ${upstreamOpts}
                </select>
                <button class="applyPF px-3 py-2 rounded-xl bg-neon-600 text-black">Übernehmen</button>
              </div>
              <div class="${isWeighted?'':'hidden'} flex items-center gap-3 w-full lg:w-auto" id="wg-${l.id}">
                <div class="flex flex-col gap-1 w-full lg:w-auto">${weights || '<div class="text-sm text-white/60">Keine Gewichte definiert</div>'}</div>
                <button class="applyWG px-3 py-2 rounded-xl bg-neon-600 text-black" data-lid="${l.id}">Speichern</button>
              </div>
            </div>
          </div>`;
        wrap.appendChild(card);

        const pSel = card.querySelector('.primarySel');
        if (pSel && l.primary_upstream_id) pSel.value = l.primary_upstream_id;
        const fSel = card.querySelector('.failoverSel');
        if (fSel && Array.isArray(l.failover_upstream_ids)) Array.from(fSel.options).forEach(o => { o.selected = l.failover_upstream_ids.includes(o.value); });

        card.querySelector('.modeSel').addEventListener('change', async (e)=>{
          const mode = e.target.value; await api(`/listeners/${l.id}/mode`, { method:'POST', body: JSON.stringify({ mode })}); await refresh();
        });
        const btnPF = card.querySelector('.applyPF');
        if (btnPF) btnPF.addEventListener('click', async ()=>{
          const primary_upstream_id = pSel.value;
          const failover_upstream_ids = Array.from(fSel.selectedOptions).map(o=>o.value);
          await api(`/listeners/${l.id}/mode`, { method:'POST', body: JSON.stringify({ mode:'primary', primary_upstream_id, failover_upstream_ids })});
          showToast('Listener aktualisiert'); await refresh();
        });
        const btnWG = card.querySelector('.applyWG');
        if (btnWG) btnWG.addEventListener('click', async ()=>{
          const inputs = $$('.weight-input', card);
          const arr = inputs.map(inp => ({ upstream_id: inp.dataset.uid, weight: Number(inp.value||0) }));
          state.config.weighted = state.config.weighted || {}; state.config.weighted[l.id] = arr;
          await api('/save', { method:'POST' }); showToast('Gewichte gespeichert'); await refresh();
        });
      });
    }

    function renderUpstreams(){
      const wrap = $('#upstreams');
      wrap.innerHTML = '';
      const list = state.config?.upstreams || [];
      if (!list.length){ $('#upstreamsEmpty').classList.remove('hidden'); return; } else { $('#upstreamsEmpty').classList.add('hidden'); }
      list.forEach(u => {
        const status = state.metrics?.upstreams?.find(x=>x.id===u.id)?.status || null;
        const ok = status?.ok;
        const card = document.createElement('div'); card.className = 'p-4 rounded-xl bg-white/5 border border-white/10';
        card.innerHTML = `
          <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-3">
            <div>
              <div class="font-semibold">${u.name} ${ok? pill('OK','ok') : status? pill('Fehler','bad'): pill('unbekannt','warn')}</div>
              <div class="text-sm text-white/70">${u.host}:${u.port}</div>
            </div>
            <div class="flex flex-wrap items-center gap-2">
              <label class="text-sm text-white/70">Aktiv</label>
              <input type="checkbox" class="toggleU scale-125" ${u.enabled? 'checked':''} />
              <input type="text" class="px-3 py-2 bg-white/5 border border-white/10 rounded-xl hostInp" value="${u.host}"/>
              <input type="number" class="w-24 px-3 py-2 bg-white/5 border border-white/10 rounded-xl portInp" value="${u.port}"/>
              <button class="saveU px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15">Speichern</button>
            </div>
          </div>`;
        wrap.appendChild(card);
        const toggle = card.querySelector('.toggleU');
        const hostInp = card.querySelector('.hostInp');
        const portInp = card.querySelector('.portInp');
        card.querySelector('.saveU').addEventListener('click', async ()=>{
          await api(`/upstreams/${u.id}`, { method:'PATCH', body: JSON.stringify({ enabled: toggle.checked, host: hostInp.value, port: Number(portInp.value) })});
          showToast('Upstream gespeichert'); await refresh();
        });
      });
    }

    function renderSessions(){
      const wrap = $('#sessions');
      const list = state.metrics?.sessions || [];
      $('#since').textContent = new Date().toLocaleTimeString();
      wrap.innerHTML = '';
      if (list.length === 0){ wrap.innerHTML = '<div class="text-white/60 text-sm">Noch keine aktiven Sessions.</div>'; return; }
      list.forEach(s => {
        const row = document.createElement('div'); row.className = 'flex items-center justify-between gap-3 p-3 rounded-lg bg-white/5 border border-white/10';
        row.innerHTML = `
          <div class="text-xs text-white/70">${s.sessionId.slice(0,8)}…</div>
          <div class="text-sm">Listener: <span class="text-white/80">${s.listenerId}</span></div>
          <div class="text-sm">Upstream: <span class="text-white/80">${s.upstreamId}</span></div>
          <div class="text-sm">↑ ${fmtBytes(s.bytesUp)} · ↓ ${fmtBytes(s.bytesDown)}</div>
          <div class="text-sm text-white/70">${s.ageSec}s</div>`;
        wrap.appendChild(row);
      });
    }

    async function refresh(){
      try {
        state.config = await api('/config');
        state.metrics = await api('/metrics');
        renderListeners(); renderUpstreams(); renderSessions();
      } catch (e) { showToast('Fehler: '+e.message, false); }
    }

    // actions
    $('#btnConnect')?.addEventListener('click', async ()=>{ state.api = $('#apiBase').value.trim(); localStorage.setItem('apiBase', state.api); await refresh(); });
    $('#btnSave')?.addEventListener('click', async ()=>{ try { await api('/save', { method:'POST' }); showToast('Konfiguration gespeichert'); } catch(e){ showToast('Fehler: '+e.message, false);} });
    $('#btnAddUp')?.addEventListener('click', async ()=>{ try { const name = $('#newName').value.trim(); const host = $('#newHost').value.trim(); const port = Number($('#newPort').value.trim()); if (!name||!host||!port) return showToast('Bitte Name/Host/Port füllen', false); await api('/upstreams', { method:'POST', body: JSON.stringify({ name, host, port })}); ['#newName','#newHost','#newPort'].forEach(s=>$(s).value=''); showToast('Upstream angelegt'); await refresh(); } catch (e) { showToast('Fehler: '+e.message, false);} });
    $('#autorefresh')?.addEventListener('change', (e)=>{ if (e.target.checked){ state.timer = setInterval(refresh, 3000); } else { clearInterval(state.timer); state.timer = null; }});

    // mobile dialog
    $('#openConnect')?.addEventListener('click', ()=>{ $('#connectDlg').classList.remove('hidden'); $('#connectDlg').classList.add('flex'); });
    $('#btnCloseMobile')?.addEventListener('click', ()=>{ $('#connectDlg').classList.add('hidden'); $('#connectDlg').classList.remove('flex'); });
    $('#btnConnectMobile')?.addEventListener('click', async ()=>{ state.api = $('#apiBaseMobile').value.trim(); localStorage.setItem('apiBase', state.api); $('#connectDlg').classList.add('hidden'); $('#connectDlg').classList.remove('flex'); await refresh(); });

    // Auto-connect
    if (state.api) refresh();
  </script></body>
</html>
