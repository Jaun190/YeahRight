<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Hashcore – Hashpower mieten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col min-h-screen">

  <!-- NAVIGATION -->
  <nav class="p-4 flex justify-between items-center bg-gray-800 shadow">
    <div class="text-xl font-bold text-blue-400">⚡ Hashcore</div>
    <div class="space-x-4">
      <button onclick="showTab('shop')" class="tablink">Shop</button>
      <button onclick="showTab('dashboard')" class="tablink">Dashboard</button>
      <button id="adminTab" onclick="showTab('admin')" class="hidden tablink">Admin</button>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <main class="flex-1 p-6">
    <!-- Wallet -->
    <div id="walletStatus" class="mb-6 text-green-400">Wallet wird geprüft…</div>

    <!-- Shop -->
    <section id="shop" class="tab">
      <h2 class="text-2xl font-semibold mb-4">Hashpower-Pakete</h2>
      <div id="shopContent">Bitte mit Wallet verbinden…</div>
    </section>

    <!-- Dashboard -->
    <section id="dashboard" class="tab hidden">
      <h2 class="text-2xl font-semibold mb-4">Deine Bestellungen</h2>
      <div id="orders"></div>
    </section>

    <!-- Admin -->
    <section id="admin" class="tab hidden">
      <h2 class="text-2xl font-semibold mb-4">Admin-Bereich</h2>
      <div class="mb-3">
        <input id="admOrderId" placeholder="Order-ID (Firestore-Dokument-ID)" class="w-full p-2 bg-gray-800 rounded">
      </div>
      <div class="grid grid-cols-3 gap-3 mb-3">
        <button class="btn bg-blue-500 p-2 rounded" onclick="admActivate()">Aktivieren</button>
        <button class="btn bg-gray-600 p-2 rounded" onclick="admExpire()">Beenden</button>
        <button class="btn bg-red-500 p-2 rounded" onclick="admCancel()">Stornieren</button>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <button class="btn bg-green-500 p-2 rounded" onclick="admCredit()">Gutschrift</button>
        <button class="btn bg-yellow-500 p-2 rounded" onclick="admExtend()">Verlängern</button>
      </div>
      <div id="adminOrders" class="mt-6"></div>
    </section>
  </main>

  <!-- FOOTER mit Popup-Links -->
  <footer class="p-6 mt-12 bg-gray-800 text-gray-400 text-sm">
    <div class="flex justify-between items-center">
      <!-- Links -->
      <button onclick="openModal('impressumModal')" class="text-blue-400 hover:underline">Impressum</button>
      
      <!-- Mitte -->
      <button onclick="openModal('agbModal')" class="text-blue-400 hover:underline">AGB</button>
      
      <!-- Rechts -->
      <button onclick="openModal('datenschutzModal')" class="text-blue-400 hover:underline">Datenschutz</button>
    </div>
    <p class="mt-2 text-center text-xs text-gray-500">© 2025 Hashcore – Alle Rechte vorbehalten</p>
  </footer>

  <!-- MODAL: Impressum -->
  <div id="impressumModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center">
    <div class="bg-gray-900 p-6 rounded max-w-lg">
      <h3 class="text-xl font-bold mb-2">Impressum</h3>
      <p>Hashcore<br>
      Dorfstrasse 233<br>
      3432 Schwanden i.E<br>
      Schweiz</p>
      <p>E-Mail: <a href="mailto:jaun190@gmail.com" class="text-blue-400">jaun190@gmail.com</a></p>
      <button onclick="closeModal('impressumModal')" class="mt-4 bg-red-500 px-4 py-2 rounded">Schließen</button>
    </div>
  </div>

  <!-- MODAL: AGB -->
  <div id="agbModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center">
    <div class="bg-gray-900 p-6 rounded max-w-lg">
      <h3 class="text-xl font-bold mb-2">Allgemeine Geschäftsbedingungen (AGB)</h3>
      <p>Mit der Bestellung eines Hashpower-Pakets akzeptieren Sie unsere allgemeinen Geschäftsbedingungen.
      Hashcore vermittelt ausschließlich Rechenleistung (Hashrate). 
      Es handelt sich nicht um Finanzprodukte oder Anlageberatung. 
      Gewinne oder Mining-Erträge werden nicht garantiert, sondern ergeben sich aus den jeweiligen Mining-Pools. 
      Der Kunde trägt die Verantwortung für die Auswahl seiner Wallet- und Pool-Adressen.</p>
      <button onclick="closeModal('agbModal')" class="mt-4 bg-red-500 px-4 py-2 rounded">Schließen</button>
    </div>
  </div>

  <!-- MODAL: Datenschutz -->
  <div id="datenschutzModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center">
    <div class="bg-gray-900 p-6 rounded max-w-lg">
      <h3 class="text-xl font-bold mb-2">Datenschutzerklärung</h3>
      <p>Wir speichern nur die für die Abwicklung notwendigen Daten (Wallet-Adresse, Bestellungen, Status).
      Es werden keine personenbezogenen Daten wie Name oder Adresse erhoben. 
      Die Datenverarbeitung erfolgt ausschließlich über Firebase/Firestore. 
      Eine Weitergabe an Dritte findet nicht statt, außer soweit zur Vertragserfüllung notwendig.</p>
      <button onclick="closeModal('datenschutzModal')" class="mt-4 bg-red-500 px-4 py-2 rounded">Schließen</button>
    </div>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, getDoc, getDocs,
      updateDoc, onSnapshot, serverTimestamp, query, where, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDD2Oo7F-68An2esILVDnfmga1nM-OPKcw",
      authDomain: "yeah-e9c83.firebaseapp.com",
      projectId: "yeah-e9c83",
      storageBucket: "yeah-e9c83.firebasestorage.app",
      messagingSenderId: "94111647513",
      appId: "1:94111647513:web:c4b0596d01a9eaf7c4a788"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const OWNER_WALLET = "0xcb165aF669733864F27070454Ac6C37deC991fFD".toLowerCase();
    const state = { wallet:null, isAdmin:false };

    window.showTab = (id) => {
      document.querySelectorAll(".tab").forEach(t=>t.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
      if(id==="admin"){ refreshAdmin(); }
    };
    showTab("shop");

    async function connectWallet(){
      if(typeof window.ethereum==="undefined"){
        document.getElementById("walletStatus").textContent="MetaMask nicht gefunden. Bitte im MetaMask-Browser öffnen.";
        return;
      }
      try {
        const accounts = await window.ethereum.request({method:"eth_requestAccounts"});
        state.wallet = accounts[0];
        document.getElementById("walletStatus").textContent = "Wallet: "+state.wallet;
        state.isAdmin = (state.wallet.toLowerCase()===OWNER_WALLET);
        if(state.isAdmin){ document.getElementById("adminTab").classList.remove("hidden"); }
        renderShop();
        loadOrders();
        if(state.isAdmin) refreshAdmin();
      } catch(e){
        document.getElementById("walletStatus").textContent = "Wallet-Verbindung abgebrochen.";
        console.error(e);
      }
    }
    connectWallet();

    function toWeiHex(eth){
      const s = String(eth);
      const [ints,decs=""] = s.split(".");
      const decPad = (decs + "000000000000000000").slice(0,18);
      const wei = BigInt(ints)*10n**18n + BigInt(decPad);
      return "0x"+wei.toString(16);
    }

    async function renderShop(){
      const shopDiv=document.getElementById("shopContent");
      if(!state.wallet){ shopDiv.textContent="Bitte Wallet verbinden."; return; }
      shopDiv.innerHTML="";
      const pkgs=[
        {id:"p1",name:"Starter 10 MH/s – 24h",price:0.01},
        {id:"p2",name:"Pro 50 MH/s – 3 Tage",price:0.05},
        {id:"p3",name:"Elite 200 MH/s – 7 Tage",price:0.2}
      ];
      pkgs.forEach(p=>{
        const div=document.createElement("div");
        div.className="p-4 bg-gray-800 rounded mb-4";
        div.innerHTML=`<div class="font-semibold">${p.name}</div>
        <div>Preis: ${p.price} ETH (inkl. Servicegebühr)</div>
        <button class="mt-2 bg-blue-500 px-4 py-2 rounded" onclick="buy('${p.id}','${p.name}',${p.price})">Kaufen</button>`;
        shopDiv.appendChild(div);
      });
    }

    window.buy=async(id,name,price)=>{
      if(!state.wallet)return alert("Bitte Wallet verbinden.");
      try{
        const tx=await window.ethereum.request({
          method:"eth_sendTransaction",
          params:[{
            from:state.wallet,
            to:OWNER_WALLET,
            value: toWeiHex(price)
          }]
        });
        await addDoc(collection(db,"orders"),{
          wallet:state.wallet,package:name,price,status:"client_paid",
          tx,createdAt:serverTimestamp()
        });
        alert("Bestellung eingetragen!");
      }catch(e){alert("Fehler: "+(e?.message||e));}
    };

    function loadOrders(){
      if(!state.wallet) return;
      const q=query(collection(db,"orders"),where("wallet","==",state.wallet),orderBy("createdAt","desc"));
      onSnapshot(q,snap=>{
        const div=document.getElementById("orders");
        div.innerHTML="";
        snap.forEach(docu=>{
          const o=docu.data();
          const el=document.createElement("div");
          el.className="p-3 bg-gray-800 rounded mb-2";
          el.innerHTML=`<div class="font-semibold">${o.package} – ${o.price} ETH</div>
            <div>Status: ${o.status}</div>
            <div>TX: ${o.tx?`<a class='text-blue-400' target='_blank' href='https://etherscan.io/tx/${o.tx}'>${o.tx.slice(0,12)}…</a>`:"-"}</div>`;
          div.appendChild(el);
        });
      });
    }

    async function refreshAdmin(){
      if(!state.isAdmin)return;
      const q=query(collection(db,"orders"),orderBy("createdAt","desc"),limit(50));
      const snap=await getDocs(q);
      const div=document.getElementById("adminOrders");
      div.innerHTML="";
      snap.forEach(d=>{
        const o=d.data();
        div.innerHTML+=`<div class="p-2 bg-gray-700 rounded mb-1"><span class="text-xs text-gray-300">${d.id}</span><br>${o.wallet} – ${o.package} – <span class="font-semibold">${o.status}</span></div>`;
      });
    }
    window.admActivate=async()=>{
      const id=document.getElementById("admOrderId").value.trim();
      if(!id)return alert("Order-ID eingeben.");
      await updateDoc(doc(db,"orders",id),{status:"active",activatedAt:serverTimestamp()});
      alert("Aktiviert."); refreshAdmin();
    };
    window.admExpire=async()=>{
      const id=document.getElementById("admOrderId").value.trim();
      if(!id)return alert("Order-ID eingeben.");
      await updateDoc(doc(db,"orders",id),{status:"expired",expiredAt:serverTimestamp()});
      alert("Beendet."); refreshAdmin();
    };
    window.admCredit=async()=>{
      const id=document.getElementById("admOrderId").value.trim();
      if(!id)return alert("Order-ID eingeben.");
      const amount=prompt("ETH-Gutschrift (nur Info-Feld):");
      await updateDoc(doc(db,"orders",id),{credited:(parseFloat(amount)||0)});
      alert("Gutschrift gesetzt."); refreshAdmin();
    };
    window.admExtend=async()=>{
      const id=document.getElementById("admOrderId").value.trim();
      if(!id)return alert("Order-ID eingeben.");
      const days=prompt("Tage verlängern (Info-Feld):");
      await updateDoc(doc(db,"orders",id),{extendDays:(parseInt(days)||0)});
      alert("Verlängerung gesetzt."); refreshAdmin();
    };
    window.admCancel=async()=>{
      const id=document.getElementById("admOrderId").value.trim();
      if(!id)return alert("Order-ID eingeben.");
      const ref=doc(db,"orders",id);
      const snap=await getDoc(ref);
      if(!snap.exists())return alert("Order nicht gefunden.");
      const o=snap.data();
      if(o.status==="awaiting_payment"){
        await updateDoc(ref,{status:"cancelled",cancelledAt:serverTimestamp()});
        alert("Bestellung storniert (nicht bezahlt).");
      }else if(o.status==="client_paid"){
        await updateDoc(ref,{status:"refunded",refundedAt:serverTimestamp()});
        alert("Als erstattet markiert (on-chain Erstattung separat durchführen).");
      }else if(o.status==="active"){
        alert("Aktive Pakete erst beenden, dann stornieren.");
      }else{
        await updateDoc(ref,{status:"cancelled",cancelledAt:serverTimestamp()});
        alert("Bestellung storniert.");
      }
      refreshAdmin();
    };

    // Modal-Steuerung
    window.openModal = (id) => {
      document.getElementById(id).classList.remove("hidden");
    }
    window.closeModal = (id) => {
      document.getElementById(id).classList.add("hidden");
    }
  </script>
</body>
</html>
