<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hashcore</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    :root { color-scheme: dark; }
    body { background:#0b1220; color:#e5e7eb; }
    .card{background:#0b0f1a;border:1px solid #1f2937;border-radius:1rem}
    .btn{padding:.75rem 1rem;border-radius:.9rem;cursor:pointer}
    .btn-sm{padding:.45rem .7rem;font-size:.8rem;border-radius:.6rem}
    .btn-primary{background:#3b82f6;color:#0b1220}
    .btn-primary:hover{background:#2563eb}
    .btn-ghost{background:#0f172a;border:1px solid #253046;color:#e5e7eb}
    .btn-ghost:hover{background:#111827}
    .chip{display:inline-flex;align-items:center;gap:.5rem;padding:.25rem .6rem;border-radius:9999px;border:1px solid #334155;background:#0f172a;color:#a3a3a3;font-size:.75rem}
    .modal{display:none}
    .modal.show{display:flex}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace}
    .disabled { opacity: .5; pointer-events: none; }
  </style>

  <style>
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:100; align-items:center; justify-content:center; }
    .modal.show { display:flex; }
    .modal-card { background:#0b0f1a; border:1px solid #1f2937; border-radius:1rem; max-width:800px; width:92%; max-height:80vh; overflow:auto; padding:1.25rem; }
    .modal-close { float:right; cursor:pointer; font-size:1.25rem; color:#9ca3af; }
    .modal-close:hover { color:#e5e7eb; }
  </style>

</head>
<body>
  <header class="sticky top-0 z-40 bg-gray-900/80 backdrop-blur border-b border-gray-800">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-blue-500/20 grid place-items-center">âš¡</div>
        <div class="text-xl font-extrabold tracking-tight">Hash<span class="text-blue-400">core</span></div>
        <div id="vipBadge" class="chip hidden">VIP</div>
      </div>
      <nav class="flex items-center gap-2">
        <button class="btn btn-ghost" onclick="navTo('shop')">Shop</button>
        <button class="btn btn-ghost" onclick="navTo('dashboard')">Dashboard</button>
        <button id="adminTab" class="btn btn-ghost hidden" onclick="secureNavAdmin()">Admin</button>
        <button id="btnConnect" class="btn btn-primary btn-sm ml-2">Mit MetaMask verbinden</button>
        <button id="btnDisconnect" class="btn btn-ghost btn-sm ml-2 hidden">Trennen</button>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <div class="card p-4 flex items-center gap-3">
      <div class="text-sm text-gray-400">Wallet</div>
      <div class="mono text-green-400 text-xs" id="walletStatus">nicht verbunden</div>
      <div class="ml-auto text-xs text-gray-400" id="chainStatus"></div>
    </div>

    <!-- MetaMask Banner -->
    <div id="mmMissing" class="card p-4 border border-red-800 bg-red-900/30 hidden">
      <div class="text-lg font-semibold text-red-300">MetaMask nicht gefunden</div>
      <p class="text-sm text-red-200 mt-1">
        Ã–ffne die Seite im integrierten <span class="font-semibold">MetaMaskâ€‘Browser</span> (Mobile) oder installiere die Extension (Desktop).
      </p>
      <div class="mt-3 flex flex-col sm:flex-row gap-2">
        <a id="btnOpenApp" class="btn btn-primary w-full sm:w-auto" href="#">In MetaMaskâ€‘App Ã¶ffnen</a>
        <a id="btnInstallMM" class="btn btn-ghost w-full sm:w-auto" target="_blank" rel="noopener"
           href="https://metamask.io/download/">MetaMask installieren</a>
      </div>
    </div>

    <!-- SHOP -->
    <section id="shop" class="tab">
      <div class="grid md:grid-cols-3 gap-4 mt-1">
        <div class="md:col-span-2 card p-5">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold text-blue-300">Hashpowerâ€‘Pakete</h2>
            <div class="chip">Zahlung: BTC</div>
          </div>

          <div class="grid sm:grid-cols-3 gap-3 mt-4">
            <div class="sm:col-span-1">
              <label class="text-xs text-gray-400" for="inputAlgo">Coin / Algorithmus</label>
              <select id="inputAlgo" class="w-full bg-gray-900 border border-gray-700 rounded p-2">
                <option value="etchash">ETC â€“ Etchash</option>
                <option value="kawpow">RVN â€“ KawPow</option>
                <option value="kheavyhash">KAS â€“ kHeavyHash</option>
              </select>
            </div>
            <div class="sm:col-span-2">
              <label class="text-xs text-gray-400" for="inputPayout">Payoutâ€‘/Walletâ€‘Adresse (oder Poolâ€‘User)</label>
              <input id="inputPayout" class="w-full bg-gray-900 border border-gray-700 rounded p-2" placeholder="0x..., RVN..., KAS...">
            </div>
          </div>

          <div id="shopContent" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3 mt-5"></div>
          <div id="lockHint" class="text-xs text-yellow-300 mt-2 hidden">ðŸ”’ Verbinde zuerst MetaMask, um zu bestellen.</div>
          <p class="text-xs text-gray-400 mt-3">
            Mit Kauf erwirbst du eine zeitlich befristete Rechenleistung. Keine Ertragsgarantie. 
            <a class="text-blue-300 underline" href="javascript:void(0)" onclick="openModal('agb')">AGB</a> Â· 
            <a class="text-blue-300 underline" href="javascript:void(0)" onclick="openModal('dse')">Datenschutz</a>
          </p>
        </div>

        <div class="card p-5">
          <h3 class="font-semibold text-blue-300">Zahlung</h3>
          <div class="mt-2 text-sm">
            <div class="mb-2"><span class="text-gray-400">Nur BTC:</span> Zahlung ausschlieÃŸlich an deine <strong>BTCâ€‘Adresse</strong>.</div>
            <div class="mb-2"><span class="text-gray-400">MetaMask Pflicht:</span> Ohne MetaMask kein Zugriff auf Kauf/Tracking.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="tab hidden">
      <div class="grid md:grid-cols-3 gap-4">
        <div class="md:col-span-2 card p-5">
          <h2 class="text-lg font-bold text-blue-300">Meine Bestellungen</h2>
          <div id="orders" class="mt-3 space-y-2"></div>
        </div>
        <div class="card p-5">
          <h3 class="font-semibold text-blue-300">Ãœbersicht</h3>
          <div class="mt-2 text-sm">
            <div class="flex justify-between"><span class="text-gray-400">Bestellungen</span><span class="mono" id="sumOrders">0</span></div>
            <div class="flex justify-between"><span class="text-gray-400">VIPâ€‘Status</span><span id="vipLabel" class="mono">Nein</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="admin" class="tab hidden">
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-bold text-blue-300">Admin</h2>
          <div class="chip">Nur Betreiberâ€‘Wallet</div>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mt-3">
          <div class="card p-4 md:col-span-2">
            <h3 class="font-semibold mb-2">Ãœbersicht (KPIs)</h3>
            <div id="adminKpis" class="grid sm:grid-cols-3 gap-3 text-sm">
              <div class="card p-3"><div class="text-gray-400 text-xs">Bestellungen gesamt</div><div id="kpiOrders" class="mono text-lg">â€“</div></div>
              <div class="card p-3"><div class="text-gray-400 text-xs">Summe Zahlbetrag (BTC)</div><div id="kpiSumBtc" class="mono text-lg">â€“</div></div>
              <div class="card p-3"><div class="text-gray-400 text-xs">Davon â€žawaiting_fundingâ€œ</div><div id="kpiAwait" class="mono text-lg">â€“</div></div>
            </div>
          </div>

          <div class="card p-4">
            <h3 class="font-semibold mb-2">Bestellungen</h3>
            <div id="adminOrders" class="overflow-x-auto text-sm"></div>
          </div>
          <div class="card p-4">
            <h3 class="font-semibold mb-2">Einstellungen</h3>
            <div class="space-y-3">
              <div>
                <label class="text-xs text-gray-400">BTCâ€‘Zahlungsadresse (wird Kunden angezeigt)</label>
                <div class="flex gap-2">
                  <input id="adminBtcAddr" class="w-full bg-gray-900 border border-gray-700 rounded p-2 mono" placeholder="bc1...">
                  <button class="btn btn-ghost" onclick="saveBtcAddr()">Speichern</button>
                </div>
                <p class="text-xs text-gray-500 mt-1">Hinweis: Ohne BTCâ€‘Adresse kÃ¶nnen Kunden nicht zahlen.</p>
              </div>

              <div>
                <div class="text-xs text-gray-400 mb-1">Orderâ€‘ID (fÃ¼r Aktionen)</div>
                <input id="admOrderId" class="w-full bg-gray-900 border border-gray-700 rounded p-2 mono" placeholder="Firestoreâ€‘Dokumentâ€‘ID">
                <div class="grid grid-cols-3 gap-2 mt-2">
                  <button class="btn btn-primary w-full" onclick="adminUpdate('active')">Aktivieren</button>
                  <button class="btn btn-ghost w-full" onclick="adminUpdate('expired')">Beenden</button>
                  <button class="btn btn-ghost w-full" onclick="adminUpdate('cancelled')">Stornieren</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    

    
  </main>

  <footer class="mt-10 border-t border-gray-800">
    <div class="max-w-6xl mx-auto px-4 py-6 flex flex-col sm:flex-row items-center justify-between gap-3 text-sm text-gray-400">
      <div class="order-2 sm:order-1">Â© 2025 Hashcore</div>
      <div class="order-1 sm:order-2 flex items-center gap-4">
        <a href="javascript:void(0)" onclick="openModal('agb')" class="hover:text-gray-200">AGB</a>
        <a href="javascript:void(0)" onclick="openModal('dse')" class="hover:text-gray-200">Datenschutz</a>
        <a href="javascript:void(0)" onclick="openModal('impressum')" class="hover:text-gray-200">Impressum</a>
      </div>
    </div>
  </footer>


  <!-- BTC Modal -->
  <div id="btcModal" class="modal fixed inset-0 bg-black/70 items-center justify-center">
    <div class="bg-gray-900 p-6 rounded-xl max-w-lg mx-3 border border-gray-700">
      <h3 class="text-xl font-bold mb-2">BTC Zahlung</h3>
      <p class="text-sm text-gray-300">Sende den Betrag an diese BTCâ€‘Adresse:</p>
      <pre id="btcAddress" class="mt-3 p-3 bg-black/40 border border-gray-700 rounded text-yellow-300 break-all mono"></pre>
      <div class="text-xs text-gray-400 mt-1">Zu zahlender Betrag: <span id="btcAmount" class="mono text-blue-300"></span> BTC</div>
      <div class="text-xs text-gray-400 mt-1">Zahlungsâ€‘Link: <a id="btcLink" class="text-blue-300" target="_blank" rel="noopener">bitcoin:</a></div>
      <div class="mt-4 flex gap-2">
        <button class="btn btn-ghost" onclick="copyAddr()">Adresse kopieren</button>
        <button class="btn btn-primary" onclick="document.getElementById('btcModal').classList.remove('show')">SchlieÃŸen</button>
      </div>
      <p id="addrHint" class="text-xs text-gray-500 mt-3"></p>
    </div>
  </div>

  <script>
    // ---- CONFIG ----
    const OWNER_WALLET = "0xcb165af669733864f27070454ac6c37dec991ffd".toLowerCase();
    const MARGIN = 0.10;         // +10 % sichtbarer Aufschlag
    const HIDDEN_FEE = 0.05;     // +5 % versteckte GebÃ¼hr (nur im Zahlbetrag)
    const firebaseConfig = {
      apiKey: "AIzaSyDD2Oo7F-68An2esILVDnfmga1nM-OPKcw",
      authDomain: "yeah-e9c83.firebaseapp.com",
      projectId: "yeah-e9c83",
      storageBucket: "yeah-e9c83.firebasestorage.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let BTC_RECEIVE_ADDRESS = "";
    const state = { wallet:null, isAdmin:false };
    const $ = (id)=>document.getElementById(id);
    const fmt = (n)=>Number(n).toFixed(8).replace(/0+$/,'').replace(/\.$/,'');

    // ---- NAV + Admin guard ----
    function navTo(id){
      if(id==="admin" && !state.isAdmin){ alert("Kein Zugriff (nur Betreiberâ€‘Wallet)."); return; }
      document.querySelectorAll(".tab").forEach(t=>t.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
      if(id==="admin"){ refreshAdmin(); loadBtcAddr(); }
      if(id==="dashboard"){ watchOrders(); }
    }
    function secureNavAdmin(){
      if(!state.isAdmin){ alert("Kein Zugriff (nur Betreiberâ€‘Wallet)."); return; }
      navTo("admin");
    }

    // ---- MetaMask banner ----
    function updateMMBanner(){
      const hasMM = !!window.ethereum;
      if(hasMM){
        document.getElementById("mmMissing").classList.add("hidden");
        lockShop(!state.wallet);
      } else {
        const url = (location.protocol === 'file:' ? (window.DAPP_PUBLIC_URL || 'https://example.com') : location.href);
        document.getElementById("btnOpenApp").href = "metamask://dapp/" + encodeURIComponent(url);
        document.getElementById("mmMissing").classList.remove("hidden");
        lockShop(true);
      }
    }
    function lockShop(lock){
      document.querySelectorAll("#shop .btn-primary").forEach(b=>{ b.classList.toggle("disabled", lock); });
      document.getElementById("lockHint").classList.toggle("hidden", !lock);
    }
    updateMMBanner();

    // ---- Connect ----
    document.getElementById("btnConnect").onclick = async ()=>{
      if(!window.ethereum){ updateMMBanner(); return; }
      try{
        const accs = await window.ethereum.request({ method: 'eth_requestAccounts' });
        onLogin(accs[0]);
      }catch(e){ alert("MetaMask Login fehlgeschlagen: " + (e?.message||e)); }
    };
    document.getElementById("btnDisconnect").onclick = ()=>logout();

    function onLogin(addr){
      state.wallet = addr;
      state.isAdmin = (addr?.toLowerCase()===OWNER_WALLET);
      document.getElementById("walletStatus").textContent = addr;
      document.getElementById("adminTab").classList.toggle("hidden", !state.isAdmin);
      lockShop(false);
      navTo('dashboard');
      requireConsentGate();
      watchOrders();
    }
    function logout(){
      state.wallet=null;
      state.isAdmin=false;
      document.getElementById("walletStatus").textContent="nicht verbunden";
      document.getElementById("adminTab").classList.add("hidden");
      lockShop(true);
      document.getElementById("orders").innerHTML="";
      navTo('shop');
    }

    // ---- Shop (BTC only) with pricing ----
    const PKGS=[
      { id:"p1", name:"Micro 10 MH/s Â· 24h", baseBtc:0.0005 },
      { id:"p2", name:"Pro 50 MH/s Â· 3 Tage", baseBtc:0.003 },
      { id:"p3", name:"Elite 200 MH/s Â· 7 Tage", baseBtc:0.02 }
    ];
    function renderShop(){
      const wrap=$("shopContent"); wrap.innerHTML="";
      PKGS.forEach(p=>{
        const display = p.baseBtc*(1+MARGIN);           // sichtbarer Preis
        const toPay   = p.baseBtc*(1+MARGIN+HIDDEN_FEE);// Zahlungsbetrag
        const div=document.createElement("div");
        div.className="card p-4";
        div.innerHTML=`
          <div class="flex items-start justify-between">
            <div class="font-semibold">{p.name}</div>
            <div class="chip">Preis ~ {fmt(display)} BTC</div>
          </div>
          <div class="text-xs text-gray-400 mt-1">Zahlung ausschlieÃŸlich BTC</div>
          <div class="mt-3"><button class="btn btn-primary">Mit BTC zahlen</button></div>`;
        div.querySelector("button").onclick = ()=>payBTC(p, display, toPay);
        wrap.appendChild(div);
      });
    }
    renderShop();

    // ---- BTC checkout ----
    function readBuyer(){
      const algo = ($("inputAlgo")?.value || "etchash").toLowerCase();
      const payout = ($("inputPayout")?.value || "").trim();
      if(!payout){ alert("Bitte Payoutâ€‘/Walletâ€‘Adresse eingeben."); return null; }
      return { algo, payout };
    }

    async function payBTC(pkg, displayPrice, toPayAmount){
      if(!state.wallet){ alert("Bitte zuerst mit MetaMask verbinden."); return; }
      const buyer = readBuyer(); if(!buyer) return;

      // (Optional) AGB BestÃ¤tigung
      if(!confirm("Ich habe die AGB & DatenschutzerklÃ¤rung gelesen und akzeptiere sie.")) return;

      await loadBtcAddr();
      if(!BTC_RECEIVE_ADDRESS){ alert("Zahlung derzeit nicht mÃ¶glich: BTCâ€‘Adresse des Betreibers ist noch nicht hinterlegt."); return; }

      document.getElementById("btcAddress").innerText = BTC_RECEIVE_ADDRESS;
      document.getElementById("btcAmount").innerText = fmt(toPayAmount);
      document.getElementById("btcLink").href = `bitcoin:${BTC_RECEIVE_ADDRESS}?amount=${fmt(toPayAmount)}`;
      document.getElementById("btcLink").textContent = `bitcoin:${BTC_RECEIVE_ADDRESS}?amount=${fmt(toPayAmount)}`;
      document.getElementById("addrHint").innerText = "Adresse geladen.";
      document.getElementById("btcModal").classList.add("show");

      try{
        await db.collection("orders").add({
          wallet: state.wallet,
          package: pkg.name,
          status: "awaiting_funding",
          algo: buyer.algo,
          payout: buyer.payout,
          paymentMethod: "BTC",
          basePriceBtc: pkg.baseBtc,
          displayPriceBtc: Number(fmt(displayPrice)),
          payAmountBtc: Number(fmt(toPayAmount)),
          marginPct: MARGIN,
          hiddenFeePct: HIDDEN_FEE,
          btcAddress: BTC_RECEIVE_ADDRESS,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        navTo('dashboard');
      }catch(err){ alert("Fehler beim Anlegen der Bestellung: "+(err.message||err)); }
    }

    // ---- Dashboard ----
    let _ordersUnsub = null;
    function watchOrders(){
      if(!state.wallet) return;
      if(_ordersUnsub) { _ordersUnsub(); _ordersUnsub=null; }
      const ordersEl = $("orders");
      _ordersUnsub = db.collection("orders").where("wallet","==",state.wallet).orderBy("createdAt","desc")
        .onSnapshot(snap=>{
          ordersEl.innerHTML="";
          let count=0;
          snap.forEach(d=>{
            count++;
            const o=d.data();
            const row=document.createElement("div");
            row.className="card p-3";
            row.innerHTML=`<div class="flex items-center justify-between">
              <div>
                <div class="font-semibold">${o.package}</div>
                <div class="text-xs text-gray-400">Status: ${o.status} â€¢ Preis: ${o.displayPriceBtc} BTC</div>
                <div class="text-xs text-gray-500">Zu zahlen: ${o.payAmountBtc} BTC â€¢ Algo: ${o.algo||"-"} â€¢ Payout: <span class="mono">${(o.payout||"").slice(0,12)}â€¦</span></div>
              </div>
              <div class="text-xs mono">${(o.btcAddress||"").slice(0,12)}â€¦</div>
            </div>`;
            ordersEl.appendChild(row);
          });
          document.getElementById("sumOrders").textContent = count;
          const vip = count >= 5;
          document.getElementById("vipBadge").classList.toggle("hidden", !vip);
          document.getElementById("vipLabel").textContent = vip ? "Ja" : "Nein";
        });
    }

    // ---- Admin (guarded) ----
    async function refreshAdmin(){
      const cont=$("adminOrders"); cont.innerHTML="";
      if(!state.isAdmin){ cont.innerHTML='<div class="text-sm text-gray-500">Kein Zugriff (nicht Admin).</div>'; return; }
      const snap=await db.collection("orders").orderBy("createdAt","desc").limit(100).get();
      let total=0, awaiting=0, sumBtc=0;
      const rows = snap.docs.map(d=>{
        const o=d.data();
        total++;
        if(o.status==='awaiting_funding') awaiting++;
        if(typeof o.payAmountBtc==='number') sumBtc += o.payAmountBtc;
        return `<tr>
          <td class="px-2 py-1 mono text-xs">${d.id}</td>
          <td class="px-2 py-1 mono text-xs">${(o.wallet||"").slice(0,8)}â€¦</td>
          <td class="px-2 py-1">${o.package}</td>
          <td class="px-2 py-1">${o.status}</td>
          <td class="px-2 py-1 text-xs">Base: ${o.basePriceBtc} â€¢ Vis.: ${o.displayPriceBtc} â€¢ Pay: ${o.payAmountBtc}<br/>Algo: ${o.algo||'-'} â€¢ Payout: ${(o.payout||'').slice(0,12)}â€¦</td>
        </tr>`;
      }).join("");
      document.getElementById('kpiOrders').textContent = String(total);
      document.getElementById('kpiSumBtc').textContent = (sumBtc||0).toFixed(8).replace(/0+$/,'').replace(/\.$/,'') || '0';
      document.getElementById('kpiAwait').textContent = String(awaiting);
      cont.innerHTML = `<table class="min-w-full">
        <thead class="text-xs text-gray-400"><tr>
          <th class="text-left px-2 py-1">ID</th><th class="text-left px-2 py-1">Wallet</th><th class="text-left px-2 py-1">Paket</th>
          <th class="text-left px-2 py-1">Status</th><th class="text-left px-2 py-1">Preise</th>
        </tr></thead>
        <tbody>${rows || '<tr><td class="px-2 py-3 text-gray-500" colspan="5">Keine Bestellungen.</td></tr>'}</tbody>
      </table>`;
    }
    async function adminUpdate(newStatus){
      if(!state.isAdmin) return alert("Nur Admin.");
      const id = $("admOrderId").value.trim(); if(!id) return alert("Orderâ€‘ID eingeben.");
      try{ await db.collection("orders").doc(id).set({ status:newStatus }, { merge:true }); alert("Status auf '"+newStatus+"' gesetzt."); refreshAdmin(); }
      catch(e){ alert("Fehler: "+(e.message||e)); }
    }

    // ---- Settings: BTC address ----
    async function loadBtcAddr(){
      try{
        const doc = await db.collection("_settings").doc("general").get();
        BTC_RECEIVE_ADDRESS = doc.exists ? (doc.data().btcAddress||"") : "";
        if(state.isAdmin){ $("adminBtcAddr").value = BTC_RECEIVE_ADDRESS||""; }
      }catch(e){ console.warn("loadBtcAddr:", e); }
    }
    async function saveBtcAddr(){
      if(!state.isAdmin) return alert("Nur Admin.");
      const v = $("adminBtcAddr").value.trim();
      if(!/^([13]|bc1)[a-zA-HJ-NP-Z0-9]{25,}$/.test(v)){ if(!confirm("Adresse konnte nicht validiert werden. Trotzdem speichern?")) return; }
      BTC_RECEIVE_ADDRESS = v;
      try{ await db.collection("_settings").doc("general").set({ btcAddress: v }, { merge:true }); alert("Gespeichert."); }
      catch(e){ alert("Fehler beim Speichern: "+(e.message||e)); }
    }

    // ---- Util ----
    function copyAddr(){
      const text = $("btcAddress").innerText.trim();
      navigator.clipboard?.writeText(text).then(()=>{$("addrHint").innerText="Adresse kopiert."}).catch(()=>{$("addrHint").innerText="Konnte nicht kopieren."});
    }

    // Init
    renderShop();
    updateMMBanner();
  </script>

  <!-- Modals -->
  <div id="modal-agb" class="modal" onclick="backdropClose(event)">
    <div class="modal-card" onclick="event.stopPropagation()">
      <div class="flex items-start justify-between mb-2">
        <h2 class="text-lg font-bold text-blue-300">Allgemeine GeschÃ¤ftsbedingungen (AGB)</h2>
        <button class="modal-close" onclick="closeModal('agb')">âœ•</button>
      </div>
      <div class="text-sm leading-6 text-gray-300 space-y-3">
        <p><strong>1. Geltungsbereich</strong><br>
        Diese AGB regeln das VertragsverhÃ¤ltnis zwischen <strong>Hashcore</strong>, 
        <strong>Dorfstrasse 233, 3433 Schwanden i.E., Schweiz</strong> (nachfolgend â€žAnbieterâ€œ) und den Nutzern.</p>

        <p><strong>2. Leistungsbeschreibung</strong><br>
        Der Anbieter stellt zeitlich befristete Rechenleistung (â€žHashpowerâ€œ) bereit. Die Leistung kann Ã¼ber <strong>Drittanbieter</strong>
        bezogen und dem Nutzer zugeordnet werden. Der Anbieter verkauft keine KryptowÃ¤hrungen und bietet keine Anlageprodukte an.</p>

        <p><strong>3. Bestellung &amp; Bezahlung</strong><br>
        Bestellungen erfolgen ausschlieÃŸlich gegen Vorauszahlung in Bitcoin (BTC) an die im Bestellprozess angegebene Adresse.
        Erst nach Zahlungseingang wird die Bestellung ausgefÃ¼hrt.</p>

        <p><strong>4. Pflichten des Nutzers</strong><br>
        Der Nutzer ist verantwortlich fÃ¼r die korrekte Angabe seiner Wallet-/Payoutâ€‘Adresse. Fehlerhafte Angaben gehen zu Lasten des Nutzers.
        Eine RÃ¼ckerstattung nach AusfÃ¼hrung der Bestellung ist ausgeschlossen.</p>

        <p><strong>5. Haftungsausschluss</strong><br>
        Es besteht keine Garantie auf bestimmte Miningâ€‘ErtrÃ¤ge. Netzwerkâ€‘/Poolâ€‘/Anbieterâ€‘StÃ¶rungen kÃ¶nnen die Leistung beeinflussen.</p>

        <p><strong>6. Recht &amp; Gerichtsstand</strong><br>
        Es gilt das Recht der Schweiz. Gerichtsstand ist <strong>Schwanden i.E.</strong>.</p>

        <p class="text-xs text-gray-500">Stand: 2025</p>
      </div>
    </div>
  </div>

  <div id="modal-dse" class="modal" onclick="backdropClose(event)">
    <div class="modal-card" onclick="event.stopPropagation()">
      <div class="flex items-start justify-between mb-2">
        <h2 class="text-lg font-bold text-blue-300">DatenschutzerklÃ¤rung</h2>
        <button class="modal-close" onclick="closeModal('dse')">âœ•</button>
      </div>
      <div class="text-sm leading-6 text-gray-300 space-y-3">
        <p>Wir, <strong>Hashcore</strong>, nehmen den Schutz Ihrer Daten ernst. Personenbezogene Daten werden gemÃ¤ÃŸ geltendem Recht
        und dieser ErklÃ¤rung verarbeitet.</p>

        <p><strong>1. Verantwortlicher</strong><br>
        Hashcore, Dorfstrasse 233, 3433 Schwanden i.E., Schweiz</p>

        <p><strong>2. Verarbeitete Daten</strong><br>
        Walletâ€‘Adressen, Bestellâ€‘/Transaktionsdaten sowie technisch notwendige Informationen (z.â€¯B. Serverâ€‘Logs).</p>

        <p><strong>3. Zwecke &amp; Rechtsgrundlagen</strong><br>
        VertragserfÃ¼llung, Support, Sicherheit und gesetzliche Pflichten.</p>

        <p><strong>4. Weitergabe an Dritte</strong><br>
        Nur soweit zur Leistungserbringung (z.â€¯B. Einbindung von Drittanbietern fÃ¼r Rechenleistung) oder gesetzlich erforderlich.</p>

        <p><strong>5. Rechte der Nutzer</strong><br>
        Auskunft, Berichtigung, LÃ¶schung, EinschrÃ¤nkung der Verarbeitung. Anfragen an die im Impressum genannten Kontaktdaten.</p>

        <p class="text-xs text-gray-500">Stand: 2025</p>
      </div>
    </div>
  </div>

  <div id="modal-impressum" class="modal" onclick="backdropClose(event)">
    <div class="modal-card" onclick="event.stopPropagation()">
      <div class="flex items-start justify-between mb-2">
        <h2 class="text-lg font-bold text-blue-300">Impressum</h2>
        <button class="modal-close" onclick="closeModal('impressum')">âœ•</button>
      </div>
      <div class="text-sm leading-6 text-gray-300">
        Hashcore<br/>Dorfstrasse 233<br/>3433 Schwanden i.E.<br/>Schweiz
        <div class="text-xs text-gray-500 mt-3">Â© 2025 Hashcore</div>
      </div>
    </div>
  </div>

  <script>
    function openModal(which){ document.getElementById('modal-'+which).classList.add('show'); }
    function closeModal(which){ document.getElementById('modal-'+which).classList.remove('show'); }
    function backdropClose(ev){ if(ev.target.classList.contains('modal')){ ev.target.classList.remove('show'); } }
  </script>


  <!-- Consent Modal (AGB & Datenschutz) -->
  <div id="modal-consent" class="modal" onclick="backdropClose(event)">
    <div class="modal-card" onclick="event.stopPropagation()">
      <div class="flex items-start justify-between mb-2">
        <h2 class="text-lg font-bold text-blue-300">Rechtliches bestÃ¤tigen</h2>
        <button class="modal-close" onclick="closeModal('consent')">âœ•</button>
      </div>
      <div class="text-sm leading-6 text-gray-300 space-y-4">
        <label class="flex items-start gap-2">
          <input id="chkAgb" type="checkbox" class="mt-1">
          <span>Ich habe die <a href="javascript:void(0)" onclick="openModal('agb')" class="text-blue-300 underline">AGB</a> gelesen und akzeptiere sie.</span>
        </label>
        <label class="flex items-start gap-2">
          <input id="chkDse" type="checkbox" class="mt-1">
          <span>Ich habe die <a href="javascript:void(0)" onclick="openModal('dse')" class="text-blue-300 underline">DatenschutzerklÃ¤rung</a> gelesen und akzeptiere sie.</span>
        </label>
        <div class="flex justify-end gap-2 pt-2">
          <button class="btn btn-ghost" onclick="closeModal('consent')">Abbrechen</button>
          <button id="btnConsentAccept" class="btn btn-primary disabled" onclick="acceptConsent()" disabled>Akzeptieren</button>
        </div>
        <p class="text-xs text-gray-500">Beide KÃ¤stchen ankreuzen, um fortzufahren.</p>
      </div>
    </div>
  </div>


  <script>
    const CONSENT_KEY = "hashcore_consent_v1";
    function requireConsentGate(){
      try {
        const ok = localStorage.getItem(CONSENT_KEY) === "1";
        if(!ok){
          // Lock Shop-Buttons bis Akzeptanz
          lockShop(true);
          openModal('consent');
          // Wire checkboxes
          const a = document.getElementById('chkAgb');
          const d = document.getElementById('chkDse');
          const btn = document.getElementById('btnConsentAccept');
          function sync(){
            const ready = a.checked && d.checked;
            btn.disabled = !ready;
            btn.classList.toggle('disabled', !ready);
          }
          a.onchange = d.onchange = sync; sync();
        }
      } catch(e){}
    }
    function acceptConsent(){
      try { localStorage.setItem(CONSENT_KEY, "1"); } catch(e){}
      lockShop(false);
      closeModal('consent');
    }
  </script>

</body>
</html>
